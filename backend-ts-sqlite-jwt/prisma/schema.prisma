generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "windows"]
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

//// =========================
////  AUTH
//// =========================

model User {
  id           Int      @id @default(autoincrement())
  name         String
  email        String   @unique
  passwordHash String
  role         String   @default("USER")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

//// =========================
////  CLIENTES
//// =========================

model Cliente {
  id             Int     @id @default(autoincrement())
  tipoCliente    String  @default("PERSONA")
  codigo         String?
  nombre         String
  empresa        String?
  nombreContacto String?
  ruc            String? @unique
  razonSocial    String?
  telefono1      String?
  telefono2      String?
  correo1        String?
  correo2        String?
  direccion      String?
  observacion    String?
  estado         String  @default("ACTIVO")

  // Crédito
  creditoHabilitado     Boolean @default(true)
  creditoMaximoCordoba  Decimal @default(100000)
  creditoMaximoDolar    Decimal @default(2739.73)

  ventas     Venta[]
  remisiones Remision[]
  productosCotizados ProductoCotizado[]
  proformas  Proforma[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

//// =========================
////  INVENTARIO
//// =========================

model Marca {
  id          Int          @id @default(autoincrement())
  nombre      String       @unique
  descripcion String?
  inventarios Inventario[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model Categoria {
  id          Int          @id @default(autoincrement())
  nombre      String       @unique
  descripcion String?
  inventarios Inventario[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model TipoCambio {
  id        Int      @id @default(autoincrement())
  fecha     DateTime @default(now())
  valor     Decimal
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TipoMovimiento {
  id          Int                    @id @default(autoincrement())
  nombre      String                 @unique
  afectaStock Boolean
  esEntrada   Boolean
  descripcion String?
  movimientos MovimientoInventario[]
  createdAt   DateTime               @default(now())
  updatedAt   DateTime               @updatedAt
}

model Inventario {
  id          Int       @id @default(autoincrement())
  numeroParte String
  marcaId     Int
  marca       Marca     @relation(fields: [marcaId], references: [id])
  categoriaId Int
  categoria   Categoria @relation(fields: [categoriaId], references: [id])
  nombre      String
  descripcion String?
  stockActual Int       @default(0)
  stockMinimo Int?

  // Ubicación física (ej. A1..A12, B1..B12, ... Z1..Z12)
  // Permitimos que varios artículos compartan la misma ubicación
  ubicacion   String?

  // Estado del producto
  descontinuado Boolean @default(false)

  // Córdobas
  costoPromedioCordoba       Decimal @default(0)
  precioVentaPromedioCordoba Decimal @default(0)
  precioVentaSugeridoCordoba Decimal @default(0)

  // Dólares
  costoPromedioDolar       Decimal @default(0)
  precioVentaPromedioDolar Decimal @default(0)
  precioVentaSugeridoDolar Decimal @default(0)

  codigoSustituto  String?
  marcaSustitutoId Int?
  sustituto        Inventario?  @relation("Sustituto", fields: [codigoSustituto, marcaSustitutoId], references: [numeroParte, marcaId])
  sustituciones    Inventario[] @relation("Sustituto")

  // Compatibilidad y precios de competencia (tablas relacionales)
  maquinasCompatibles      CompatibilidadMaquina[]
  preciosCompetenciaRows   PrecioCompetencia[]

  movimientos           MovimientoInventario[]
  detalleCompras        DetalleCompra[]
  detalleVentas         DetalleVenta[]
  detalleDevVentas      DetalleDevolucionVenta[]
  detalleDevCompras     DetalleDevolucionCompra[]
  detalleCambiosSalida  DetalleCambio[]           @relation("CambioSalida")
  detalleCambiosEntrada DetalleCambio[]           @relation("CambioEntrada")
  detalleRemisiones     DetalleRemision[]
  cotizacionesProducto ProductoCotizado[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([numeroParte, marcaId], name: "UQ_NumeroParte_Marca")
  @@index([ubicacion])
}

model CompatibilidadMaquina {
  id           Int        @id @default(autoincrement())
  inventarioId Int
  inventario   Inventario @relation(fields: [inventarioId], references: [id])
  nombre       String
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}

model PrecioCompetencia {
  id              Int        @id @default(autoincrement())
  inventarioId    Int
  inventario      Inventario @relation(fields: [inventarioId], references: [id])
  proveedor       String
  precioCordoba   Decimal?
  precioDolar     Decimal?
  fecha           DateTime?
  referencia      String?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
}

model MovimientoInventario {
  id                         Int            @id @default(autoincrement())
  inventarioId               Int
  inventario                 Inventario     @relation(fields: [inventarioId], references: [id])
  tipoMovimientoId           Int
  tipoMovimiento             TipoMovimiento @relation(fields: [tipoMovimientoId], references: [id])
  fecha                      DateTime       @default(now())
  cantidad                   Int

  costoUnitarioCordoba       Decimal?
  precioVentaUnitarioCordoba Decimal?
  costoUnitarioDolar         Decimal?
  precioVentaUnitarioDolar   Decimal?
  tipoCambioValor            Decimal?
  observacion                String?
  usuario                    String?

  detalleRemision DetalleRemision? @relation("RemisionMovimiento")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model DetalleRemision {
  id           Int        @id @default(autoincrement())
  remisionId   Int
  remision     Remision   @relation(fields: [remisionId], references: [id])
  inventarioId Int
  inventario   Inventario @relation(fields: [inventarioId], references: [id])
  cantidad     Int
  facturado    Boolean    @default(false)

  movimientoId Int? @unique
  movimiento   MovimientoInventario? @relation("RemisionMovimiento", fields: [movimientoId], references: [id])

  detalleVenta DetalleVenta?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}


//// =========================
////  REMISIONES
//// =========================

model Remision {
  id          Int      @id @default(autoincrement())
  numero      String   @unique
  fecha       DateTime @default(now())
  clienteId   Int
  cliente     Cliente  @relation(fields: [clienteId], references: [id])
  entregadoA  String?
  usuario     String?
  observacion String?
  pio         String?
  facturada   Boolean  @default(false)

  detalles DetalleRemision[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Proforma {
  id             Int       @id @default(autoincrement())
  fecha          DateTime  @default(now())
  clienteId      Int?
  cliente        Cliente?  @relation(fields: [clienteId], references: [id])
  totalCordoba   Decimal   @default(0)
  totalDolar     Decimal   @default(0)
  tipoCambioValor Decimal?
  pio            String?
  incoterm       String?
  plazoEntrega   String?
  condicionPago  String?
  detallesJson   String
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([clienteId, fecha])
}

model ProductoCotizado {
  id               Int          @id @default(autoincrement())
  inventarioId     Int?
  inventario       Inventario?  @relation(fields: [inventarioId], references: [id])
  clienteId        Int?
  cliente          Cliente?     @relation(fields: [clienteId], references: [id])
  cantidad         Int          @default(1)
  precioCordoba    Decimal      @default(0)
  precioDolar      Decimal      @default(0)
  moneda           String       @default("NIO")
  numeroParteLibre String?
  nombreLibre      String?
  fecha            DateTime     @default(now())
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  @@index([inventarioId, fecha])
  @@index([clienteId])
}


//// =========================
////  COMPRAS
//// =========================

model Compra {
  id               Int                @id @default(autoincrement())
  fecha            DateTime           @default(now())
  proveedor        String
  numeroFactura    String?
  totalCordoba     Decimal?
  totalDolar       Decimal?
  tipoCambioValor  Decimal            @default(36.50)
  usuario          String?
  observacion      String?
  detalles         DetalleCompra[]
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  DevolucionCompra DevolucionCompra[]
}

model DetalleCompra {
  id                   Int        @id @default(autoincrement())
  compraId             Int
  compra               Compra     @relation(fields: [compraId], references: [id])
  inventarioId         Int
  inventario           Inventario @relation(fields: [inventarioId], references: [id])
  cantidad             Int
  costoUnitarioCordoba Decimal
  costoUnitarioDolar   Decimal
  createdAt            DateTime   @default(now())
  updatedAt            DateTime   @updatedAt
}

//// =========================
////  VENTAS
//// =========================

model Venta {
  id    Int      @id @default(autoincrement())
  fecha DateTime @default(now())

  clienteId Int?
  cliente   Cliente? @relation(fields: [clienteId], references: [id])

  numeroFactura String?

  tipoPago         String    @default("CONTADO")
  plazoDias        Int?
  fechaVencimiento DateTime?
  montoPendiente   Decimal?  @default(0)
  estadoPago       String    @default("PAGADO")
  cancelada        Boolean   @default(false)

  totalCordoba    Decimal?
  totalDolar      Decimal?
  tipoCambioValor Decimal  @default(36.50)

  usuario     String?
  observacion String?
  pio         String?

  detalles DetalleVenta[]

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  DevolucionVenta DevolucionVenta[]
}

model DetalleVenta {
  id           Int        @id @default(autoincrement())
  ventaId      Int
  venta        Venta      @relation(fields: [ventaId], references: [id])
  inventarioId Int
  inventario   Inventario @relation(fields: [inventarioId], references: [id])
  cantidad     Int

  // Código que se usó para facturar (puede ser sustituto)
  codigoFacturar String?

  remisionDetalleId Int?             @unique
  remisionDetalle   DetalleRemision? @relation(fields: [remisionDetalleId], references: [id])

  precioUnitarioCordoba Decimal
  precioUnitarioDolar   Decimal

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

//// =========================
////  DEVOLUCIONES
//// =========================

model DevolucionVenta {
  id        Int                      @id @default(autoincrement())
  ventaId   Int
  venta     Venta                    @relation(fields: [ventaId], references: [id])
  fecha     DateTime                 @default(now())
  cliente   String?
  motivo    String?
  usuario   String?
  cobrada   Boolean                  @default(false)
  detalles  DetalleDevolucionVenta[]
  createdAt DateTime                 @default(now())
  updatedAt DateTime                 @updatedAt
}

model DetalleDevolucionVenta {
  id                    Int             @id @default(autoincrement())
  devolucionVentaId     Int
  devolucionVenta       DevolucionVenta @relation(fields: [devolucionVentaId], references: [id])
  inventarioId          Int
  inventario            Inventario      @relation(fields: [inventarioId], references: [id])
  cantidad              Int
  precioUnitarioCordoba Decimal
  precioUnitarioDolar   Decimal
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
}

model DevolucionCompra {
  id        Int                       @id @default(autoincrement())
  compraId  Int
  compra    Compra                    @relation(fields: [compraId], references: [id])
  fecha     DateTime                  @default(now())
  proveedor String?
  motivo    String?
  usuario   String?
  detalles  DetalleDevolucionCompra[]
  createdAt DateTime                  @default(now())
  updatedAt DateTime                  @updatedAt
}

model DetalleDevolucionCompra {
  id                   Int              @id @default(autoincrement())
  devolucionCompraId   Int
  devolucionCompra     DevolucionCompra @relation(fields: [devolucionCompraId], references: [id])
  inventarioId         Int
  inventario           Inventario       @relation(fields: [inventarioId], references: [id])
  cantidad             Int
  costoUnitarioCordoba Decimal
  costoUnitarioDolar   Decimal
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt
}

//// =========================
////  CAMBIOS
//// =========================

model Cambio {
  id          Int             @id @default(autoincrement())
  fecha       DateTime        @default(now())
  cliente     String?
  motivo      String?
  usuario     String?
  observacion String?
  detalles    DetalleCambio[]
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
}

model DetalleCambio {
  id                    Int        @id @default(autoincrement())
  cambioId              Int
  cambio                Cambio     @relation(fields: [cambioId], references: [id])
  inventarioSalidaId    Int
  inventarioSalida      Inventario @relation("CambioSalida", fields: [inventarioSalidaId], references: [id])
  inventarioEntradaId   Int
  inventarioEntrada     Inventario @relation("CambioEntrada", fields: [inventarioEntradaId], references: [id])
  cantidadSalida        Int
  cantidadEntrada       Int
  precioUnitarioCordoba Decimal
  precioUnitarioDolar   Decimal
  createdAt             DateTime   @default(now())
  updatedAt             DateTime   @updatedAt
}

//// =========================
////  CONFIGURACION
//// =========================

model Configuracion {
  id                    Int      @id @default(autoincrement())
  ruc                   String   @unique
  razonSocial           String
  direccion             String
  telefono1             String?
  telefono2             String?
  correo                String?
  sitioWeb              String?
  logoUrl               String?
  mensajeFactura        String?
  numeroFacturaInicial  Int?     @default(1)
  ultimoNumeroFactura   Int?     @default(0)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

model MetodoPago {
  id            Int      @id @default(autoincrement())
  nombre        String
  tipoCuenta    String   // BANCO, EFECTIVO, TRANSFERENCIA, etc.
  banco         String?
  numeroCuenta  String?
  titular       String?
  moneda        String   @default("NIO") // NIO o USD
  activo        Boolean  @default(true)
  observaciones String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}
